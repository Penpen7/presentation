---
title: テストメソッド名にこだわっている話
author: ネオ美魔
---

自己紹介
---

<!-- column_layout: [4, 3] -->
<!-- column: 0 -->
# 名前
Penpen7
# 職種
バックエンドエンジニア
# 好きな言語
Rust, Go
# 仕事
KINTO FACTORYの開発に携わっています
# コメント
今回はterminal上でスライドを作ってみました

<!-- column: 1 -->
![](me.png)
箱根旅行での私

<!-- end_slide -->
単体テストでのテストコード
---
<!-- column_layout: [1, 1] -->
<!-- column: 0 -->
# テスト対象のコード
```file +line_numbers {3-6}
path: ./src/main.go
language: go
```
<!-- column: 1 -->
# テストコード
```file +line_numbers {5-11}
path: ./src/main_test.go
language: go
```
<!-- reset_layout -->
# テスト実行
```bash +exec
/// go clean -testcache
/// cd src
go test ./... -v
```
<!-- end_slide -->
本番に近いテストコードで考えてみる
---
今回はECサイトの在庫管理システムを例に考えてみる

<!-- column_layout: [1, 1] -->
<!-- column: 0 -->
# ECサイトの在庫管理システムの仕様
- 商品を確保することができる
- 商品が確保できたら在庫数を減らす
- 在庫数が0の商品は確保できない

<!-- column: 1 -->
# プロダクションコード
- 在庫管理システム構造体とKeepItemメソッドを作った
```go
// 在庫管理システム
type StockSystem struct {}

// 商品を確保する
func (c *StockSystem) KeepItem(itemID string) error {}
```
# テストコード
```go
func Test_正常系_在庫数が0より大きい場合(t *testing.T) { }
func Test_異常系_在庫切れエラー(t *testing.T) { }
```
<!-- end_slide -->
どこが悪いのか？
---

どういう意図で書かれたテストコードなのかがわかりにくい

# 期待している結果がわかりにくい
在庫数が0より大きい場合、どうなるのが正しいのか🤔
```go
func Test_正常系_在庫数が0より大きい場合(t *testing.T) { }
```
# 前提条件がわかりにくい
在庫切れエラーとはどういう条件で起きるのか🤔
```go
func Test_異常系_在庫切れエラー(t *testing.T) { }
```

<!-- end_slide -->
どこが悪いのか？
---
`{ テスト対象メソッド }_{ 事前条件 }_{ 想定する結果 }`に変えてみる
# 期待している結果がわかりやすくなった
```diff
- func Test_正常系_在庫数が0より大きい場合(t *testing.T) { }
+ func Test_KeepItem_在庫数が0より大きい場合_正常終了(t *testing.T) { }
```
# どういう条件下でテストしているかわかりやすくなった
```diff
- func Test_在庫切れエラー(t *testing.T) { }
+ func Test_KeepItem_在庫数が0の場合_在庫切れエラー(t *testing.T) { }
```

これもまだわかりにくい
<!-- end_slide -->
さらに改善する
---
# なんでわかりづらいか？
- テストメソッド名にHowが書いてあるから
  - 正常終了する、 エラーが発生するなどは技術的な「手段」であって「目的」ではないはず
- テスト対象のメソッド名をテストメソッド名に含めるのはアンチパターン

# では、テストメソッド名には何を書くのか？
- テストメソッド名には「What」を書く
- 非エンジニアにも伝わるように、どういう問題を解決するのかを書く
  - 例: 商品の在庫数が0より大きい場合、商品を確保できる
- どうテストするかはテストメソッド内に書く

```diff
- func Test_KeepItem_在庫数が0より大きい場合_正常終了(t *testing.T) { }
+ func Test_商品の在庫数が0より大きい場合_商品を確保できる(t *testing.T) { 
+     // ここにHOWを書く(在庫数が減っているか、エラーが発生していないかなど)
+ }
```

```diff
- func Test_KeepItem_在庫数が0の場合_在庫切れエラー(t *testing.T) { }
+ func Test_商品在庫数が0の場合_商品を確保できない(t *testing.T) { }
```
<!-- end_slide -->

そもそもなんでテストするんだっけ？
---

# ソフトウェアを持続可能的に成長させるため
- 時間が経つにつれて仕様やコードが複雑化していき、変更が難しくなる
- 最初の頃はテストを書かない方が早くコードを書ける
- 長期的にみるとテストコードがある方が「早く」開発できる

![image:width:50%](graph.png)
<!-- end_slide -->
じゃあ、テストをとにかく書けば良いということ？
---
# そうではない
- テストがあれば、最初のうちはコードの劣化を防ぐことができる
- しかし、質の悪いテストはやがてメンテナンスを困難にする(コードは全て負債になる)
- 質の良いテストコードを書くことが大事

<!-- column_layout: [1, 1] -->
<!-- column: 0 -->
![image:width:90%](graph.png)
<!-- column: 1 -->
![image:width:100%](./quality_test_graph.png)
<!-- end_slide -->
質の良いテストコードを書くために
---
# 「わかりやすいテストメソッド名にこだわる」のはテストコードの質を向上させるための手段の一つ
## テストメソッド名がわかりやすいと、
- コード全体を読まなくてもテストケースの内容がわかる
## テストメソッド名がわかりにくいと、
- テストコード全体を読まないとテストケースの内容がわからない
- テストコードの可読性が低いことが多く、何もわからん...になる
<!-- end_slide -->
まとめ
---

- テストコードはソフトウェアを持続可能的に成長させるために書く
- 質の悪いテストコードは長期的にみて成長を阻害するため、質の良いテストコードを書くことが大事
- 質の良いテストコードを書く手段の一つとして理解しやすいテストメソッド名にこだわってみましょう
  - 可読性の高いテストコードを書くのは難しいので、まずはやりやすいところから始める
- テストメソッド名は非エンジニアでも理解できるように書いておくとなお良い
  - 将来の自分や他のエンジニアにとっても嬉しい
