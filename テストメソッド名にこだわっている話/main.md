---
title: テストメソッド名にこだわっている話
author: ネオ美魔
theme:
    name: tokyonight-storm
---

自己紹介
---

<!-- column_layout: [4, 3] -->
<!-- column: 0 -->
# 名前
Penpen7
# 職種
バックエンドエンジニア
# 好きな言語
Rust, Go
# 仕事
KINTO FACTORYの開発に携わっています
# コメント
今回はterminal上でスライドを作ってみました

<!-- column: 1 -->
![](me.png)
箱根旅行での私

<!-- end_slide -->
<!-- jump_to_middle -->
皆さん普段からテストコード書いてますか？
---

<!-- end_slide -->
<!-- jump_to_middle -->
もちろん、息をするように書いてますよね？
---
<!-- end_slide -->
<!-- jump_to_middle -->
ところで、テスト書くのなんか辛くないですか？
---
<!-- end_slide -->
辛いこと
--

- なんやこの分かりづらいテストコード...と思っていたら、自分が昔書いたコードだった
- 他の人が書いたテストコードをレビューしていて、内容わからんけどなんとなくApproveしてしまった

---
このあたりの辛さを解消するための話をしたいと思います

<!--end_slide-->
今回言いたいこと
---
# テスト・メソッドにわかりやすい名前をつけるようにしよう
# エンジニア「以外」が読んでも理解できるくらいに
<!-- end_slide -->
<!-- jump_to_middle -->
テスト・メソッドってなに？
---
<!-- end_slide -->

テストコード
---
<!-- column_layout: [1, 1] -->
<!-- column: 0 -->
# テスト対象のコード
```file +line_numbers {3-6}
path: ./src/main.go
language: go
```
<!-- column: 1 -->
# テストコード
```file +line_numbers {5-11}
path: ./src/main_test.go
language: go
```
<!-- reset_layout -->
# テスト実行
```bash +exec
/// go clean -testcache
/// cd src
go test ./... -v
```
<!-- end_slide -->

これがテストメソッド
---
```file +line_numbers {5}
path: ./src/main_test.go
language: go
```
<!-- end_slide -->

これがテストメソッドの名前
--
```go
Test_合計値を計算できる
```
- 名前からどういうテストを実行しているかがわかる
- これを分かりやすくしようという話

<!-- end_slide -->
ありえそうな例でやってみる
---

# ECサイトの販売システムの仕様
- ユーザは商品を購入できる
- 商品を購入できたら在庫数を減らす
- 在庫数が0の商品は購入できない

<!-- column_layout: [1, 1] -->
<!-- column: 0 -->
# プロダクションコード
```go
// ECサイトシステム構造体
type ECSystem struct {
    // 商品ごとの在庫数
    stock map[string]int
}

// 商品を購入するメソッド
func (c *ECSystem) Order(itemID string) error {
    // 商品がなければエラー
    if c.stock[itemID] <= 0 {
        return ErrOutOfStock
    }

    // 商品があれば在庫数を減らす
    c.stock[itemID]--
    return nil
}
```

<!-- column: 1 -->
# テストコード
```go
func Test_正常系_在庫数が0より大きい場合(t *testing.T) { }
func Test_異常系_在庫切れエラー(t *testing.T) { }
```
<!-- end_slide -->
どういう意図で書かれたテストコードなのかがわかりにくい
---


# 在庫数が0より大きい場合、どうなるのが正しいのか🤔
```go
func Test_正常系_在庫数が0より大きい場合(t *testing.T) { }
```
# 在庫切れエラーとはどういう条件で起きるのか🤔

```go
func Test_異常系_在庫切れエラー(t *testing.T) { }
```
<!--end_slide-->
<!-- jump_to_middle -->
テストメソッド名を変えてみる
---

<!--end_slide-->
<!-- jump_to_middle -->
`{ テスト対象メソッド }_{ 事前条件 }_{ 想定する結果 }`というルールにしましょう
---

<!-- end_slide -->
`{ テスト対象メソッド }_{ 事前条件 }_{ 想定する結果 }`に変えてみる
---
- 事前条件と期待する結果をテストメソッド名に含めるとよい
```go
func Test_KeepItem_在庫数が0より大きい場合_正常終了(t *testing.T) { }
```
```go
func Test_KeepItem_在庫数が0の場合_在庫切れエラー(t *testing.T) { }
```
さっきよりは良くなった

<!-- end_slide -->
まだまだ改善の余地がある
---
- テストメソッド名に対象メソッド名を含めるのはアンチパターン
  - 振る舞いをテストすべきだから
- テストメソッド名にHow(どうテストするか)が含まれているため、読みにくい
 - 読んだときに脳内でHowからWhat(何をテストしているか)へ言い換えているはずで、脳に負荷がかかる

## Orderが正常終了ってことは...ユーザが商品を購入できるってことか...
```go
func Test_Order_在庫数が0より大きい場合_正常終了(t *testing.T) { }
```
## Orderが在庫切れエラーを返すってことは...ユーザが商品を購入できないってことか...
```go
func Test_Order_在庫数が0の場合_在庫切れエラー(t *testing.T) { }
```
<!-- end_slide -->

では、テストメソッド名には何を書くのか？
---
- テストメソッド名には「What」を書く
- 非エンジニア(ドメイン・エキスパート)にも伝わる、説明できるように端的に書く
- 「How」はテストメソッド内に書く

```go
func Test_商品の在庫がある場合_ユーザは商品を購入できる(t *testing.T) { 
   // ここでエラーが発生していないかをみる
}
```

```go
func Test_商品の在庫がない場合_ユーザは商品を購入できない(t *testing.T) {
    // ここで在庫エラーが発生しているかをみる
}
```
<!-- end_slide -->
非エンジニアにも伝わる名前にしなくても良いのでは？
---
# 開発者がわかる名前だと暗号めいた名前になりがち

- 実際に何を検証し、どのような要件と対応しているか把握しにくくなる
- 結果、コードのメンテナンスが困難になる
- 将来の自分や他のエンジニアのためにも、非エンジニアが読めるくらいにわかりやすく書くことが重要

<!-- end_slide -->
まとめ
---

- どのようなテストをしているか把握しやすくするためにテスト・メソッド名を工夫しよう
- 非エンジニアでも理解できるくらいまで端的に書いてみよう
- 名前を変えるだけでテストコードの品質が向上できるであれば、コスパがいいと感じませんか？
